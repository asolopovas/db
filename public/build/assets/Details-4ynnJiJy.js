import{d as ue,p as c,ar as N,C as k,E as ce,x as pe,B as p,L as s,e as C,k as w,f as o,r as F,F as h,K as b,i as l,h as U,M as r,au as fe,N as me,Q as ve,n as J,am as Y,ap as ge,T as we,o as d}from"./app-DWdjb6xN.js";import{_ as be}from"./DisplayField.vue_vue_type_script_setup_true_lang-Ct4HLrCI.js";const ye=["src"],xe={class:"max-w-[1004px] mx-auto shadow-lg"},_e={class:"flex flex-wrap bg-stone-200 mx-auto mt-4 py-4"},ke={class:"flex flex-col gap-3 items-start w-full p-4"},Ce={class:"grid md:grid-cols-2 lg:grid-cols-4 w-full gap-2 mb-4"},he={class:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-3 w-full"},$e={class:"flex flex-col w-full"},De={class:"order-controls grid md:grid-cols-2 lg:grid-cols-4 gap-2"},Oe={class:"flex flex-col mb-4 w-full"},Se={class:"messages-controls grid grid-cols-4 gap-2"},Me={class:"toggle-container justify-self-end"},Ne={class:"flex gap-4 w-full justify-end pb-12"},Fe={class:"flex flex-col gap-2 min-w-[320px]"},Ie={class:"grid grid-cols-3 gap-2"},Re={class:"w-1/2 grid grid-cols-2 gap-2 col-start-2 items-center"},Ae=ue({__name:"Details",setup(Te){const I=ge(),$=we(),n=ce(),X=c({}),D=c(!1),x=c(!1),R=c(null),T=c(!1),B=c(!1),q=c(!1),A=c(!1),z=c(null),j=c(!1),y=c(null),_=c([]),G=c({setter:"setOrderStats",parent:"order",items:{customer:{type:"input-search",format:t=>`${t.firstname} ${t.lastname}`},status:{type:"input-search",skip:[2]},project:{type:"input-search",format:t=>t?t.street:""},company:{type:"input-search"}}}),O=c({setter:"setOrderStats",parent:"order",items:{date_due:{type:"input-field",cast:"date",format:t=>N.dateFormat(t,"yyyy-MM-dd")},vat:{type:"input-field"},discount:{type:"input-field"},due:{type:"input-field"},due_amount:{type:"input-field"}}}),H=c({setter:"setOrderStats",parent:"order",items:{created_at:{label:"Created At",type:"display-field",format:N.dateFormat},updated_at:{label:"Updated At",type:"display-field",format:N.dateFormat},sent:{type:"display-field",format:N.dateFormat}}}),Q=k({get:()=>n.state.order.reverse_charge,set:t=>{n.commit("setOrderStats",{value:t,loc:"reverse_charge"}),S(!1)}}),W=k(()=>n.state.auth.access_token),P=k(()=>{const t=(n.state.order.products||[]).length>0,e=(n.state.order.order_materials||[]).length>0;return t||e}),V=k(()=>(n.state.order.order_services||[]).length>0),Z=k(()=>y.value==="materials_products"?"Do you confirm duplicating this order with materials and products only?":y.value==="services_only"?"Do you confirm duplicating this order with services only?":"Do you confirm duplicating this order?");pe(()=>$.query.duplicated,async t=>{if(!(Array.isArray(t)?t.includes("1"):t==="1"))return;z.value=Number($.params.id)||null,A.value=!0;const m={...$.query};delete m.duplicated,await I.replace({path:$.path,query:m})},{immediate:!0});function ee(){A.value=!1}function E(t){t==="materials_products"&&!P.value||t==="services_only"&&!V.value||(y.value=t,j.value=!0)}function L(){j.value=!1,y.value=null}async function te(){if(!y.value)return;const t=y.value;L(),await ie(t)}async function se(){D.value=!1,x.value=!0,await n.dispatch("orderSend"),x.value=!1}function S(t=!1){_.value.length||(x.value=!0,n.dispatch("orderSave",t).then(()=>x.value=!1))}const K=async()=>{const t=n.state.order.status.name==="Quote"?"/api/settings/get/quotation_message":"/api/settings/get/invoice_message";try{const{data:e}=await Y(t,{method:"GET"});n.commit("setOrderStats",{value:e,loc:"mail_message"}),S(!0)}catch(e){console.error("Failed to fetch mail message:",e)}};function oe(){n.dispatch("orderSaveItem",{mail_message:n.state.order.mail_message})}const ae=async()=>{try{const{data:t}=await Y(`/api/orders/${n.state.order.id}/download`,{method:"GET",responseType:"blob"}),e=t,m=window.URL.createObjectURL(e),u=document.createElement("a");u.href=m;const v=n.state.order,f=[v.customer.firstname,v.customer.lastname].filter(Boolean).join("-");u.download=`Order #${v.id} - ${f}.pdf`,document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(m)}catch(t){console.error("Failed to download invoice:",t)}};function le(){const t=Date.now(),e=`width=${window.screen.availWidth/2},height=${window.screen.availHeight-60}`;window.open(`/api/orders/${n.state.order.id}/pdf-reverse-charge?token=${W.value}&time=${t}`,"_blank",e)}function re(){const t=Date.now(),e=`location=true,resizable=yes,scrollbars=yes,status=yes,width=${window.screen.availWidth/2},height=${window.screen.availHeight-60},left=0,top=0`;window.open(`/api/orders/${n.state.order.id}/pdf-default?token=${W.value}&time=${t}`,"_blank",e)}function ne(){const t=n.state.order,e=[t.customer.firstname,t.customer.lastname].filter(Boolean).join(" ");I.push({name:"orders",query:{search:e}})}async function ie(t="all"){var e,m,u;if(!(t==="materials_products"&&!P.value)&&!(t==="services_only"&&!V.value))try{const v=n.state.order.id,f=await Y(`/api/orders/${v}/duplicate`,{method:"POST",body:{mode:t}}),i=((e=f==null?void 0:f.data)==null?void 0:e.id)||((u=(m=f==null?void 0:f.data)==null?void 0:m.item)==null?void 0:u.id);if(!i)throw new Error("Duplicate created but no order id returned.");const M=`/orders/${i}/details`;try{await I.push({path:M,query:{duplicated:"1"}})}catch{window.location.assign(`${M}?duplicated=1`)}}catch(v){console.error("Failed to duplicate order:",v)}}return(t,e)=>{const m=b("spinner"),u=b("modal"),v=b("input-field"),f=b("text-area"),i=b("base-button"),M=b("input-search"),de=b("order-components");return d(),p(de,{ref:"detailsContainer"},{title:s(()=>e[15]||(e[15]=[l("Details",-1)])),loading:s(()=>[x.value?(d(),p(m,{key:0})):w("",!0)]),meta:s(()=>[(d(!0),C(h,null,F(H.value.items,(a,g)=>(d(),p(be,{key:g,label:a.label,format:a.format,alerts:_.value,loc:`${H.value.parent}.${g}`},null,8,["label","format","alerts","loc"]))),128))]),default:s(()=>[(d(!0),C(h,null,F(X.value,(a,g)=>(d(),C(h,{key:g},[a.shown?(d(),p(u,{key:0,class:"send",controls:!0,onClose:()=>a.shown=!1,onYes:a.action,onNo:()=>a.shown=!1},{default:s(()=>[l(U(a.message),1)]),_:2},1032,["onClose","onYes","onNo"])):w("",!0)],64))),128)),D.value?(d(),p(u,{key:0,class:"send",controls:!0,onClose:e[0]||(e[0]=()=>D.value=!1),onYes:se},{default:s(()=>e[16]||(e[16]=[l(" Do you wish to send this order? ",-1)])),_:1,__:[16]})):w("",!0),A.value?(d(),p(u,{key:1,class:"send",controls:!1,onClose:ee},{default:s(()=>[l(" You are now viewing duplicated order #"+U(z.value)+". ",1)]),_:1})):w("",!0),j.value?(d(),p(u,{key:2,class:"send",controls:!0,onClose:L,onNo:L,onYes:te},{default:s(()=>[l(U(Z.value),1)]),_:1})):w("",!0),R.value?(d(),p(u,{key:3,class:"pdf",controls:!1,onClose:e[1]||(e[1]=()=>R.value=null)},{default:s(()=>[o("embed",{id:"pdf",src:R.value,type:"application/pdf",width:"1000",height:"550"},null,8,ye)]),_:1})):w("",!0),T.value?(d(),p(u,{key:4,class:"textarea",onClose:e[2]||(e[2]=a=>T.value=!1)},{title:s(()=>e[17]||(e[17]=[l("Mail Message",-1)])),default:s(()=>[r(v,{set:"setOrderStats",loc:"order.cc",alerts:_.value},null,8,["alerts"]),r(f,{class:"mb-4",labelOn:!1,set:"setOrderStats",loc:"order.mail_message",action:oe}),r(i,{class:"btn-action bg-sky-600 self-end text-white",onClick:K},{default:s(()=>e[18]||(e[18]=[l(" Default ",-1)])),_:1,__:[18]})]),_:1})):w("",!0),q.value?(d(),p(u,{key:5,class:"textarea",onClose:e[4]||(e[4]=a=>q.value=!1)},{title:s(()=>e[19]||(e[19]=[l("Payment Terms",-1)])),default:s(()=>[r(f,{labelOn:!1,class:"mb-4",set:"setOrderStats",loc:"order.payment_terms"}),r(i,{class:"btn-action bg-sky-600 self-end text-white",onClick:e[3]||(e[3]=()=>S(!0))},{default:s(()=>e[20]||(e[20]=[l(" Save ",-1)])),_:1,__:[20]})]),_:1})):w("",!0),B.value?(d(),p(u,{key:6,class:"textarea",onClose:e[5]||(e[5]=a=>B.value=!1)},{title:s(()=>e[21]||(e[21]=[l("Notes",-1)])),default:s(()=>[r(f,{labelOn:!1,class:"mb-4",set:"setOrderStats",loc:"order.notes"}),r(i,{class:"btn-action bg-sky-600 self-end text-white",onClick:K},{default:s(()=>e[22]||(e[22]=[l(" Default ",-1)])),_:1,__:[22]})]),_:1})):w("",!0),o("div",xe,[o("div",_e,[o("div",ke,[o("div",Ce,[(d(!0),C(h,null,F(G.value.items,(a,g)=>(d(),p(M,{wrap:"w-full md:w-auto",class:"w-full lg:max-w-[195px]",is:a.type,set:G.value.setter,skip:a.skip,format:a.format,cast:a.cast,alerts:_.value,loc:`${O.value.parent}.${g}`},null,8,["is","set","skip","format","cast","alerts","loc"]))),256))]),o("div",he,[(d(!0),C(h,null,F(O.value.items,(a,g)=>(d(),p(fe(a.type),{class:"w-full lg:w-auto",label:g,set:O.value.setter,format:a.format,cast:a.cast,alerts:_.value,loc:`${O.value.parent}.${g}`},null,8,["label","set","format","cast","alerts","loc"]))),256))]),o("div",$e,[e[27]||(e[27]=o("hr",null,null,-1)),e[28]||(e[28]=o("p",{class:"mt-2 mb-2 text-xs font-semibold uppercase tracking-wide text-neutral-600"}," Invoice Actions ",-1)),o("div",De,[r(i,{class:"btn-action bg-red-400",onClick:le},{default:s(()=>e[23]||(e[23]=[l(" Reverse Charge Invoice ",-1)])),_:1,__:[23]}),r(i,{class:"btn-action bg-yellow-500",onClick:re},{default:s(()=>e[24]||(e[24]=[l(" View Invoice ",-1)])),_:1,__:[24]}),r(i,{class:"btn-action bg-green-600 text-white",onClick:ae},{default:s(()=>e[25]||(e[25]=[l(" Download Invoice ",-1)])),_:1,__:[25]}),r(i,{class:"btn-action bg-orange-400",onClick:ne},{default:s(()=>e[26]||(e[26]=[l(" View Related Orders ",-1)])),_:1,__:[26]})])]),o("div",Oe,[e[34]||(e[34]=o("hr",{class:"mb-1"},null,-1)),e[35]||(e[35]=o("p",{class:"mb-2 text-xs font-semibold uppercase tracking-wide text-neutral-600"}," Message Actions ",-1)),o("div",Se,[r(i,{class:"btn-action bg-sky-600 text-white",onClick:e[6]||(e[6]=()=>T.value=!0)},{default:s(()=>e[29]||(e[29]=[l(" Mail ",-1)])),_:1,__:[29]}),r(i,{class:"btn-action bg-sky-600 text-white",onClick:e[7]||(e[7]=()=>B.value=!0)},{default:s(()=>e[30]||(e[30]=[l(" Notes ",-1)])),_:1,__:[30]}),r(i,{class:"btn-action bg-sky-600 text-white",onClick:e[8]||(e[8]=()=>q.value=!0)},{default:s(()=>e[31]||(e[31]=[l(" Payment Terms ",-1)])),_:1,__:[31]}),o("div",Me,[e[32]||(e[32]=o("label",{class:"toggle-label select-none cursor-pointer",for:"reverse-charge"},"Reverse Charge",-1)),me(o("input",{id:"reverse-charge",type:"checkbox",class:"checkbox","onUpdate:modelValue":e[9]||(e[9]=a=>Q.value=a)},null,512),[[ve,Q.value]]),e[33]||(e[33]=o("label",{for:"reverse-charge",class:"switch cursor-pointer"},null,-1))])])]),o("div",Ne,[o("div",Fe,[e[39]||(e[39]=o("p",{class:"text-xs font-semibold uppercase tracking-wide text-neutral-600"}," Duplicate Copy ",-1)),o("div",Ie,[r(i,{class:"btn-action bg-indigo-600 hover:bg-indigo-700 text-white text-sm",onClick:e[10]||(e[10]=()=>E("all"))},{default:s(()=>e[36]||(e[36]=[l(" All ",-1)])),_:1,__:[36]}),r(i,{class:J(["btn-action text-white text-sm",P.value?"bg-indigo-500 hover:bg-indigo-600":"bg-gray-400 cursor-not-allowed"]),onClick:e[11]||(e[11]=()=>E("materials_products"))},{default:s(()=>e[37]||(e[37]=[l(" Materials + Products ",-1)])),_:1,__:[37]},8,["class"]),r(i,{class:J(["btn-action text-white text-sm",V.value?"bg-indigo-400 hover:bg-indigo-500":"bg-gray-400 cursor-not-allowed"]),onClick:e[12]||(e[12]=()=>E("services_only"))},{default:s(()=>e[38]||(e[38]=[l(" Services Only ",-1)])),_:1,__:[38]},8,["class"])])]),o("div",Re,[e[42]||(e[42]=o("p",{class:"col-span-2 text-xs font-semibold uppercase tracking-wide text-neutral-600"}," Order Actions ",-1)),r(i,{class:"btn-action bg-yellow-300 hover:bg-yellow-400 text-black",onClick:e[13]||(e[13]=()=>D.value=!0)},{default:s(()=>e[40]||(e[40]=[l(" Send ",-1)])),_:1,__:[40]}),r(i,{class:"btn-action bg-green-700 hover:bg-green-800 text-white",onClick:e[14]||(e[14]=a=>S(!1))},{default:s(()=>e[41]||(e[41]=[l(" Save ",-1)])),_:1,__:[41]})])])])])])]),_:1},512)}}});export{Ae as default};
